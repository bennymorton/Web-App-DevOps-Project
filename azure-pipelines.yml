# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- azure-prov-test

pool:
  vmImage: ubuntu-latest

variables:
  azureKeyVaultName: 'keyvault-5076a581'

steps:
- task: Docker@2
  inputs:
    containerRegistry: 'DockerHub'
    repository: 'mayaaiuga/azure-prov-test'
    command: 'buildAndPush'
    Dockerfile: '**/Dockerfile'
    tags: 'latest'

# Fetch secrets from Azure Key Vault
- task: AzureKeyVault@2
  inputs:
    azureSubscription: 'aks-connection'
    KeyVaultName: '$(azureKeyVaultName)'
    SecretsFilter: '*'
    RunAsPreJob: true


- task: AzureCLI@2
  inputs:
    azureSubscription: 'aks-connection'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      # Install kubectl
      az aks install-cli

      # Get AKS credentials
      az aks get-credentials --resource-group 5076a581-terraform-rg --name 5076a581-aks-cluster

      # Verify kubectl context
      kubectl config current-context
      kubectl get nodes
      
      # Retrieve secrets from Azure Key Vault
      DB_SERVER=$(az keyvault secret show --name 5076a581-server-name-secret --vault-name $(keyVaultName) --query value -o tsv)
      DB_USERNAME=$(az keyvault secret show --name 5076a581-server-username-secret --vault-name $(keyVaultName) --query value -o tsv)
      DB_PASSWORD=$(az keyvault secret show --name 5076a581-server-password-secret --vault-name $(keyVaultName) --query value -o tsv)
      DB_DATABASE=$(az keyvault secret show --name 5076a581-database-name-secret --vault-name $(keyVaultName) --query value -o tsv)
      
      # Create Kubernetes secret
      kubectl create secret generic flask-app-secrets \
        --from-literal=db-server=$(DB_SERVER) \
        --from-literal=db-database=$(DB_DATABASE) \
        --from-literal=db-username=$(DB_USERNAME) \
        --from-literal=db-password=$(DB_PASSWORD) \
        --dry-run=client -o yaml > k8s-secret.yaml
      
      # Apply the Kubernetes secret
      kubectl apply -f k8s-secret.yaml

- task: KubernetesManifest@1
  inputs:
    action: 'deploy'
    connectionType: 'azureResourceManager'
    azureSubscriptionConnection: 'aks-connection'
    azureResourceGroup: '5076a581-terraform-rg'
    kubernetesCluster: '5076a581-aks-cluster'
    manifests: 'deployment.yaml'